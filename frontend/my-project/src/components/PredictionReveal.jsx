import React from "react";
import { motion, AnimatePresence } from "framer-motion";
import jsPDF from "jspdf";

/* ---------------- RISK + RECOMMENDATIONS ---------------- */

function getRiskProfile(prob) {
  if (prob >= 0.7) {
    return {
      level: "HIGH RISK",
      color: "text-red-400",
      ring: "from-red-500 to-red-400",
      message:
        "This customer shows strong churn signals and is very likely to leave without intervention.",
      actions: [
        "Proactively call the customer",
        "Offer a personalized discount or retention plan",
        "Assign to priority retention queue",
      ],
    };
  }

  if (prob >= 0.4) {
    return {
      level: "MEDIUM RISK",
      color: "text-yellow-400",
      ring: "from-yellow-400 to-yellow-300",
      message:
        "This customer shows early signs of disengagement and should be monitored closely.",
      actions: [
        "Send engagement or feedback email",
        "Offer limited-time loyalty incentives",
        "Monitor usage trends over time",
      ],
    };
  }

  return {
    level: "LOW RISK",
    color: "text-green-400",
    ring: "from-green-400 to-cyan-400",
    message:
      "This customer is likely to remain loyal. No immediate retention action is required.",
    actions: [
      "Maintain current experience",
      "Reward loyalty with occasional perks",
      "Continue passive monitoring",
    ],
  };
}

/* ---------------- COMPONENT ---------------- */

export default function PredictionReveal({ data, onClose }) {
  if (!data) return null;

  const probability = Math.round(data.churnProbability * 100);
  const profile = getRiskProfile(data.churnProbability);

  /* -------- PDF EXPORT -------- */

  const exportPDF = () => {
    const doc = new jsPDF();

    doc.setFont("helvetica", "bold");
    doc.setFontSize(18);
    doc.text("Customer Churn Prediction Report", 20, 20);

    doc.setFontSize(11);
    doc.setFont("helvetica", "normal");
    doc.text(`Generated on: ${new Date().toLocaleString()}`, 20, 30);

    doc.line(20, 34, 190, 34);

    doc.setFont("helvetica", "bold");
    doc.text("Prediction Summary", 20, 45);

    doc.setFont("helvetica", "normal");
    doc.text(`Churn Probability: ${probability}%`, 20, 55);
    doc.text(`Risk Level: ${profile.level}`, 20, 63);

    doc.setFont("helvetica", "bold");
    doc.text("Interpretation", 20, 75);

    doc.setFont("helvetica", "normal");
    doc.text(profile.message, 20, 85, { maxWidth: 170 });

    doc.setFont("helvetica", "bold");
    doc.text("Recommended Actions", 20, 110);

    doc.setFont("helvetica", "normal");
    profile.actions.forEach((action, i) => {
      doc.text(`• ${action}`, 25, 120 + i * 8);
    });

    doc.line(20, 160, 190, 160);
    doc.setFontSize(9);
    doc.text(
      "Note: This prediction is generated by a machine learning model and should be used as decision support.",
      20,
      170,
      { maxWidth: 170 }
    );

    doc.save("churn_prediction_report.pdf");
  };

  return (
    <AnimatePresence>
      <motion.div
        className="fixed inset-0 z-50 flex items-center justify-center
                   bg-black/90 backdrop-blur"
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        exit={{ opacity: 0 }}
      >
        <motion.div
          initial={{ scale: 0.85, y: 40 }}
          animate={{ scale: 1, y: 0 }}
          transition={{ duration: 0.5, ease: "easeOut" }}
          className="bg-linear-to-br from-[#0b1320] to-[#020617]
                     border border-white/10 rounded-3xl
                     p-12 w-115 text-center"
        >
          {/* Header */}
          <p className="text-xs tracking-widest uppercase text-white/50 mb-4">
            AI Churn Assessment
          </p>

          {/* Probability Orb */}
          <div className="relative flex justify-center my-6">
            <motion.div
              className={`w-36 h-36 rounded-full
                          bg-linear-to-br ${profile.ring}
                          flex items-center justify-center`}
            >
              <div className="text-center">
                <div className="text-5xl font-extrabold text-black">
                  {probability}%
                </div>
                <div className="text-xs tracking-widest uppercase text-black/70">
                  Churn Probability
                </div>
              </div>
            </motion.div>
          </div>

          {/* Risk Label */}
          <div className={`text-lg font-semibold ${profile.color}`}>
            {profile.level}
          </div>

          <p className="mt-3 text-sm text-white/70">{profile.message}</p>

          {/* Actions */}
          <div className="mt-6 text-left">
            <p className="text-xs uppercase tracking-widest text-white/40 mb-3">
              Recommended Actions
            </p>
            <ul className="space-y-2">
              {profile.actions.map((a) => (
                <li key={a} className="text-sm text-white/80">
                  • {a}
                </li>
              ))}
            </ul>
          </div>

          {/* Buttons */}
          <div className="mt-8 flex gap-4 justify-center">
            <button
              onClick={exportPDF}
              className="px-5 py-2 rounded-lg
                         bg-cyan-400 text-black text-sm font-semibold
                         hover:bg-cyan-300 transition"
            >
              ⬇ Export PDF
            </button>

            <button
              onClick={onClose}
              className="px-5 py-2 rounded-lg
                         border border-white/20 text-white/70
                         hover:bg-white/10 transition"
            >
              Close
            </button>
          </div>
        </motion.div>
      </motion.div>
    </AnimatePresence>
  );
}